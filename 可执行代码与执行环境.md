# 可执行代码与执行环境

## ES3 规范



## ES5 规范

#### 可执行代码类型

JS中一共有3种可执行代码类型

- 全局代码：这是默认或者说基础的上下文，任何不在函数内部的代码都在全局上下文中

  ​					它会执行两件事：创建一个全局的 `window `对象（浏览器的情况下），并且设置 `this` 的值等于

  ​					这个全局对象

  ​					一个程序中只会有一个全局执行上下文

- 函数执行上下文：每当一个函数被调用时, 都会为该函数创建一个新的上下文

  ​								每个函数都有它自己的执行上下文，不过是在函数被调用时创建的

  ​								函数上下文可以有任意多个。每当一个新的执行上下文被创建，它会按定义的顺序执行一系列步骤

- Eval 函数执行上下文：执行在 `eval` 函数内部的代码也会有它属于自己的执行上下文

#### 词法环境（Lexical Environment）

 词法环境 由 环境记录(Environment Record) 和 可能为 `null` 的外部词法环境引用组成

- 环境记录项 记录了在它的关联词法环境域内创建的标识符绑定情形

- 外部词法环境引用 用于表示词法环境的逻辑嵌套关系模型


词法环境有

- 全局环境
- 函数环境
- 模块环境

> 词法环境 和 环境记录项 是纯粹的规范机制，而不需要 ECMAScript 的实现保持一致。ECMAScript 程序不可能直接访问或者更改这些值

> <a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-lexical-environments">sec-lexical-environments</a>

##### 环境记录项

环境记录项：声明式环境记录项 和 对象式环境记录项

##### 外部词法环境引用

#### 可执行上下文（Execution Contexts）

简而言之，执行上下文是评估和执行 JavaScript 代码的环境的抽象概念。每当 Javascript 代码在运行的时候，它都是在执行上下文中运行。在任何时间点，最多只有一个执行上下文正在执行代码。 这被称为运行执行上下文（the running execution context）

> <a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-execution-contexts">sec-execution-contexts</a>

> 执行上下文纯粹是一个规范机制，不需要对应于ECMAScript实现的任何特定的工件。 ECMAScript代码不可能直接访问或观察执行上下文

每个执行上下文都包括以下组件

| 组件     | 作用目的                                                     |
| -------- | ------------------------------------------------------------ |
| 词法环境 | 指定一个词法环境对象，用于解析该执行环境内的代码创建的标识符引用 |
| 变量环境 | 指定一个词法环境对象，其环境数据用于保存由该执行环境内的代码通过 变量表达式 和 函数表达式 创建的绑定 |
| This绑定 | 指定该执行环境内的 ECMA 脚本代码中 this 关键字所关联的值     |

具体来说就是

`let`、`const ` 声明的变量，外部环境引用 保存在 `词法环境组件` 中
`var` 和 `function` 声明的变量 保存在 `变量环境组件` 中

#### 执行栈

执行栈，也就是在其它编程语言中所说的“调用栈”，是一种拥有 LIFO（后进先出）数据结构的栈，被用来存储代码运行时创建的所有执行上下文

当 JavaScript 引擎第一次遇到你的脚本时，它会创建一个全局的执行上下文并且压入当前执行栈。每当引擎遇到一个函数调用，它会为该函数创建一个新的执行上下文并压入栈的顶部

引擎会执行那些执行上下文位于栈顶的函数。当该函数执行结束时，执行上下文从栈中弹出，控制流程到达当前栈中的下一个上下文

## ES6 规范

##### 

#### 领域（Realms）

> <a href="http://www.ecma-international.org/ecma-262/6.0/index.html#sec-code-realms">Code Realms</a>
>
> 在评估之前，所有ECMAScript代码都必须与一个领域相关联。从概念上讲，领域由一组内部对象，一个ECMAScript全局环境，在该全局环境范围内加载的所有ECMAScript代码以及其他相关状态和资源组成

> <a href="https://stackoverflow.com/questions/49832187/how-to-understand-js-realms">stackoverflow.com how-to-understand-js-realms</a>
>
> 在浏览器中，窗口（框架，使用window.open（）打开的窗口或只是普通的浏览器选项卡）是一个领域。网络工作者是一个不同于窗口的领域，但这是一个领域。web worker也是如此