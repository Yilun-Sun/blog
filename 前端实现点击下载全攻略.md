# 前端实现点击下载全攻略

最近在做的后台管理系统，来了个小需求～要实现 `excel` 文件的导出功能。

当时眉头一皱，感觉多年以前似乎写过这样的需求，知道该怎么实现却又模模糊糊

![眉头一皱周冬雨](/Users/yuartian/Downloads/眉头一皱周冬雨.jpeg)

这次正好就来梳理一下吧～

### 基本概念

#### 1. HTML5 a 标签的`download`属性

> ​	此属性指示浏览器下载 URL 而不是导航到它，因此将提示用户将其保存为本地文件。如果属性有一个值，那么此值将在下载保存过程中作为预填充的文件名（如果用户需要，仍然可以更改文件名）。此属性对允许的值没有限制，但是 `/` 和 `\` 会被转换为下划线。大多数文件系统限制了文件名中的标点符号，故此，浏览器将相应地调整建议的文件名。
>
> 注：
>
> - 此属性仅适用于同源 URL。
> - 尽管 HTTP URL 需要位于同一源中，但是可以使用 [`blob:` URL](https://developer.mozilla.org/zh-CN/docs/Web/API/URL.createObjectURL) 和 [`data:` URL](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Data_URIs)，以方便用户下载使用 JavaScript 生成的内容（例如使用在线绘图 Web 应用程序创建的照片）。
> - 如果 HTTP 头中的 [Content-Disposition](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Disposition) 属性赋予了一个不同于此属性的文件名，HTTP 头属性优先于此属性。
> - 如果 HTTP 头属性 `Content-Disposition` 被设置为inline（即 `Content-Disposition='inline'`），那么 Firefox 优先考虑 HTTP 头 `Content-Disposition`download 属性。

#### 2. URL.createObjectURL()

> **URL.createObjectURL()** 静态方法会创建一个 [`DOMString`](https://developer.mozilla.org/zh-CN/docs/Web/API/DOMString)，其中包含一个表示参数中给出的对象的URL。这个 URL 的生命周期和创建它的窗口中的 [`document`](https://developer.mozilla.org/zh-CN/docs/Web/API/Document) 绑定。这个新的URL 对象表示指定的 [`File`](https://developer.mozilla.org/zh-CN/docs/Web/API/File) 对象或 [`Blob`](https://developer.mozilla.org/zh-CN/docs/Web/API/Blob) 对象。
>
> 注：在每次调用 `createObjectURL()` 方法时，都会创建一个新的 URL 对象，即使你已经用相同的对象作为参数创建过。当不再需要这些 URL 对象时，每个对象必须通过调用 [`URL.revokeObjectURL()`](https://developer.mozilla.org/zh-CN/docs/Web/API/URL/revokeObjectURL) 方法来释放。浏览器会在文档退出的时候自动释放它们，但是为了获得最佳性能和内存使用状况，你应该在安全的时机主动释放掉它们。

#### 3.HTMLCanvasElement.toDataURL()

> **HTMLCanvasElement.toDataURL()** 方法返回一个包含图片展示的 [data URI](https://developer.mozilla.org/en-US/docs/Web/HTTP/data_URIs) 。可以使用 `type` 参数其类型，默认为 [PNG](https://en.wikipedia.org/wiki/Portable_Network_Graphics) 格式。图片的分辨率为96dpi。
>
> - 如果画布的高度或宽度是0，那么会返回字符串“`data:,”。`
> - 如果传入的类型非“`image/png`”，但是返回的值以“`data:image/png`”开头，那么该传入的类型是不支持的。
> - Chrome支持“`image/webp`”类型。

### 实践

#### 1. 下载一张图片

​	这个是最简单的 ～

​	只要一个属性就搞定啦

​	`<a href="demo.png" download>点我下载</a>`

​	想要修改名字也可以，只需要在 `download`属性里写好

​	`<a href="demo.png" download="我的新名字.png">点我下载</a>`

​	然而。。。这玩意儿的兼容性有点问题

![download_兼容性](/Users/yuartian/Downloads/download_兼容性.png)

还附带3个已知的bug

![image-20190616153634100](/Users/yuartian/Library/Application Support/typora-user-images/image-20190616153634100.png)

Emmmmmm 。。。 IE 又是你！

#### 2. 下载动态文件

​	有时候需要下载实时生成的内容就不能只用`HTML`标签解决了。我们需要用`JS`修改 `href`属性。

- ##### 下载文本文件

  ```javascript
  function(data, filename){
    let a = document.createElement("a");
    let blob = new Blob([data]);
    let url = window.URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  }
  ```

- ##### 下载图片文件

  ```javascript
  function(img, filename){
    let a = document.createElement("a");
    let canvas = document.createElement('canvas');
    let context = canvas.getContext('2d');
    let width = domImg.naturalWidth;
    let height = domImg.naturalHeight;
    context.drawImage(img, 0, 0);
    a.href = canvas.toDataURL('image/jpeg');
    //a.href = canvas.toDataURL('image/png'); ...
    a.download = filename;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  }
  ```

#### 3. 结合异步请求

​	如果数据是后端返回的话，对于`data`的处理和上面的一样。`filename`一般会放在响应头的`content-disposition`中

```javascript
let contentDisposition = response.headers["content-disposition"];
//从 response 的 headers 中获取 filename
//后端 response.setHeader("Content-disposition", "attachment; filename=xxxx.docx") 设置的文件名;
let patt = new RegExp("filename=([^;]+\\.[^\\.;]+);*");
let result = patt.exec(contentDisposition);
let filename = decodeURI(result[1]);
```

### 兼容

#### 